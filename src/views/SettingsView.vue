<template>
  <div class="settings-view">
    <h1 class="page-title">è®¾ç½® âš™ï¸</h1>

    <!-- é€šç”¨è®¾ç½® -->
    <div class="settings-section">
      <h3 class="section-title">ğŸ”§ é€šç”¨è®¾ç½®</h3>
      <div class="settings-card card">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">å¼€æœºè‡ªå¯åŠ¨</span>
            <span class="setting-desc">ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ Desktop Beauty</span>
          </div>
          <label class="switch">
            <input type="checkbox" v-model="settings.autoStart">
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">æœ€å°åŒ–åˆ°æ‰˜ç›˜</span>
            <span class="setting-desc">å…³é—­çª—å£æ—¶æœ€å°åŒ–åˆ°ç³»ç»Ÿæ‰˜ç›˜</span>
          </div>
          <label class="switch">
            <input type="checkbox" v-model="settings.minimizeToTray">
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">å¯åŠ¨æ—¶éšè—çª—å£</span>
            <span class="setting-desc">ç¨‹åºå¯åŠ¨åç›´æ¥æœ€å°åŒ–åˆ°æ‰˜ç›˜</span>
          </div>
          <label class="switch">
            <input type="checkbox" v-model="settings.startMinimized">
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">æ¡Œé¢å°ç»„ä»¶</span>
            <span class="setting-desc">åœ¨æ¡Œé¢ä¸Šæ˜¾ç¤ºå¿«æ·æ“ä½œå°ç»„ä»¶</span>
          </div>
          <label class="switch">
            <input type="checkbox" v-model="settings.showWidget">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- å¿«æ·é”®è®¾ç½® -->
    <div class="settings-section mt-lg">
      <h3 class="section-title">âŒ¨ï¸ å¿«æ·é”®</h3>
      <div class="settings-card card">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">æ˜¾ç¤º/éšè—ä¸»çª—å£</span>
            <span class="setting-desc">å¿«é€Ÿåˆ‡æ¢ä¸»çª—å£çš„æ˜¾ç¤ºçŠ¶æ€</span>
          </div>
          <kbd class="shortcut-key">Alt + D</kbd>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">å¿«æ·å¯åŠ¨å™¨</span>
            <span class="setting-desc">æ‰“å¼€åº”ç”¨å¿«æ·å¯åŠ¨å™¨</span>
          </div>
          <kbd class="shortcut-key">Alt + Space</kbd>
        </div>
      </div>
    </div>

    <!-- æ¡Œé¢ç®¡ç†è®¾ç½® -->
    <div class="settings-section mt-lg">
      <h3 class="section-title">ğŸ–¥ï¸ æ¡Œé¢ç®¡ç†</h3>
      <div class="settings-card card">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">é»˜è®¤æ’åºæ–¹å¼</span>
            <span class="setting-desc">æ•´ç†æ¡Œé¢æ—¶çš„é»˜è®¤æ’åºè§„åˆ™</span>
          </div>
          <select v-model="settings.defaultSort" class="select-box">
            <option value="name">æŒ‰åç§°</option>
            <option value="type">æŒ‰ç±»å‹</option>
            <option value="date">æŒ‰æ—¥æœŸ</option>
            <option value="size">æŒ‰å¤§å°</option>
          </select>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">è‡ªåŠ¨åˆ†ç»„</span>
            <span class="setting-desc">æ•´ç†æ—¶è‡ªåŠ¨æŒ‰ç±»å‹åˆ›å»ºæ–‡ä»¶å¤¹</span>
          </div>
          <label class="switch">
            <input type="checkbox" v-model="settings.autoGroup">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- å£çº¸è®¾ç½® -->
    <div class="settings-section mt-lg">
      <h3 class="section-title">ğŸ–¼ï¸ å£çº¸è®¾ç½®</h3>
      <div class="settings-card card">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">è‡ªåŠ¨è½®æ¢</span>
            <span class="setting-desc">è‡ªåŠ¨åˆ‡æ¢å£çº¸</span>
          </div>
          <label class="switch">
            <input type="checkbox" v-model="settings.wallpaperSlideshow">
            <span class="slider"></span>
          </label>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">è½®æ¢é—´éš”</span>
            <span class="setting-desc">è‡ªåŠ¨åˆ‡æ¢å£çº¸çš„æ—¶é—´é—´éš”</span>
          </div>
          <select v-model="settings.wallpaperInterval" class="select-box" :disabled="!settings.wallpaperSlideshow">
            <option :value="5">5 åˆ†é’Ÿ</option>
            <option :value="15">15 åˆ†é’Ÿ</option>
            <option :value="30">30 åˆ†é’Ÿ</option>
            <option :value="60">1 å°æ—¶</option>
            <option :value="120">2 å°æ—¶</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ç›‘æ§è®¾ç½® -->
    <div class="settings-section mt-lg">
      <h3 class="section-title">ğŸ“Š ç³»ç»Ÿç›‘æ§</h3>
      <div class="settings-card card">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">åˆ·æ–°é—´éš”</span>
            <span class="setting-desc">ç³»ç»Ÿç›‘æ§æ•°æ®çš„åˆ·æ–°é¢‘ç‡</span>
          </div>
          <select v-model="settings.monitorInterval" class="select-box">
            <option :value="1000">1 ç§’</option>
            <option :value="2000">2 ç§’</option>
            <option :value="5000">5 ç§’</option>
          </select>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">ä¾§è¾¹æ æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€</span>
            <span class="setting-desc">åœ¨ä¾§è¾¹æ åº•éƒ¨æ˜¾ç¤º CPU å’Œå†…å­˜ä½¿ç”¨ç‡</span>
          </div>
          <label class="switch">
            <input type="checkbox" v-model="settings.showSidebarStats">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- å…³äº -->
    <div class="settings-section mt-lg">
      <h3 class="section-title">â„¹ï¸ å…³äº</h3>
      <div class="about-card card">
        <div class="about-logo">âœ¨</div>
        <h2>Desktop Beauty</h2>
        <p class="version">ç‰ˆæœ¬ {{ appVersion }}</p>
        <p class="desc">ä¸€ä¸ªä¼˜é›…çš„æ¡Œé¢ç®¡ç†å·¥å…·</p>
        
        <!-- æ›´æ–°æ£€æµ‹ -->
        <div class="update-section">
          <div v-if="updateState === 'idle'" class="update-check">
            <button class="btn-update" @click="checkForUpdate" :disabled="isCheckingUpdate">
              {{ isCheckingUpdate ? 'æ£€æŸ¥ä¸­...' : 'æ£€æŸ¥æ›´æ–°' }}
            </button>
          </div>
          
          <div v-else-if="updateState === 'available'" class="update-available">
            <div class="update-badge">ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬</div>
            <p class="new-version">v{{ newVersion }}</p>
            <button class="btn-download" @click="downloadUpdate" :disabled="isDownloading">
              {{ isDownloading ? `ä¸‹è½½ä¸­ ${downloadProgress}%` : 'ç«‹å³ä¸‹è½½' }}
            </button>
          </div>
          
          <div v-else-if="updateState === 'downloaded'" class="update-ready">
            <div class="update-badge success">âœ… ä¸‹è½½å®Œæˆ</div>
            <p>æ–°ç‰ˆæœ¬å·²å‡†å¤‡å°±ç»ª</p>
            <button class="btn-install" @click="installUpdate">é‡å¯å¹¶å®‰è£…</button>
          </div>
          
          <div v-else-if="updateState === 'latest'" class="update-latest">
            <span class="latest-badge">âœ“ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬</span>
          </div>
          
          <div v-else-if="updateState === 'error'" class="update-error">
            <span class="error-text">æ£€æŸ¥æ›´æ–°å¤±è´¥</span>
            <button class="btn-retry" @click="checkForUpdate">é‡è¯•</button>
          </div>
          
          <div v-else-if="updateState === 'download-error'" class="update-error">
            <span class="error-text">ä¸‹è½½å¤±è´¥: {{ errorMessage || 'ç½‘ç»œé”™è¯¯' }}</span>
            <button class="btn-retry" @click="downloadUpdate">é‡è¯•ä¸‹è½½</button>
          </div>
        </div>
        
        <div class="developer-info">
          <p>å¼€å‘è€…ï¼š<a href="#" @click.prevent="openAuthorGithub">pigWolfy</a></p>
          <p>é‚®ç®±ï¼šhappywangruifei@gmail.com</p>
        </div>
        <div class="about-links">
          <a href="#" @click.prevent="openGithub">GitHub</a>
          <span>Â·</span>
          <a href="#" @click.prevent="openFeedback">åé¦ˆé—®é¢˜</a>
        </div>
        <p class="copyright">Â© 2024 Desktop Beauty Team</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted, onUnmounted, ref } from 'vue'
import { useSettingsStore } from '../stores/settings'
import { storeToRefs } from 'pinia'

const settingsStore = useSettingsStore()
const { settings } = storeToRefs(settingsStore)
const appVersion = ref('1.0.0')

// æ›´æ–°ç›¸å…³çŠ¶æ€
const updateState = ref<'idle' | 'available' | 'downloaded' | 'latest' | 'error' | 'download-error'>('idle')
const isCheckingUpdate = ref(false)
const isDownloading = ref(false)
const downloadProgress = ref(0)
const newVersion = ref('')
const errorMessage = ref('')

// æ¸…ç†å‡½æ•°æ•°ç»„
const cleanupFns: (() => void)[] = []

onMounted(async () => {
  settingsStore.init()
  // è·å–åº”ç”¨ç‰ˆæœ¬å·
  try {
    const version = await window.electronAPI?.getAppVersion()
    if (version) {
      appVersion.value = version
    }
  } catch (e) {
    console.error('è·å–ç‰ˆæœ¬å·å¤±è´¥:', e)
  }
  
  // ç›‘å¬æ›´æ–°äº‹ä»¶
  setupUpdateListeners()
})

onUnmounted(() => {
  // æ¸…ç†äº‹ä»¶ç›‘å¬
  cleanupFns.forEach(fn => fn())
})

const setupUpdateListeners = () => {
  // æ›´æ–°æ¶ˆæ¯
  window.electronAPI?.onUpdateMessage((_, data) => {
    isCheckingUpdate.value = false
    if (data.type === 'checking') {
      isCheckingUpdate.value = true
    } else if (data.type === 'not-available') {
      updateState.value = 'latest'
      setTimeout(() => {
        updateState.value = 'idle'
      }, 3000)
    }
  })
  
  // å‘ç°æ–°ç‰ˆæœ¬
  window.electronAPI?.onUpdateAvailable((_, info) => {
    isCheckingUpdate.value = false
    updateState.value = 'available'
    newVersion.value = info.version
  })
  
  // ä¸‹è½½è¿›åº¦
  window.electronAPI?.onUpdateProgress((_, progress) => {
    downloadProgress.value = Math.round(progress.percent)
  })
  
  // ä¸‹è½½å®Œæˆ
  window.electronAPI?.onUpdateDownloaded(() => {
    isDownloading.value = false
    updateState.value = 'downloaded'
  })
  
  // æ›´æ–°é”™è¯¯
  window.electronAPI?.onUpdateError((_, error) => {
    console.error('Update error:', error)
    errorMessage.value = typeof error === 'string' ? error : 'ç½‘ç»œè¿æ¥å¤±è´¥'
    
    // æ ¹æ®å½“å‰çŠ¶æ€åˆ¤æ–­æ˜¯æ£€æŸ¥å¤±è´¥è¿˜æ˜¯ä¸‹è½½å¤±è´¥
    if (isDownloading.value) {
      isDownloading.value = false
      updateState.value = 'download-error'
    } else {
      isCheckingUpdate.value = false
      updateState.value = 'error'
    }
  })
}

const checkForUpdate = async () => {
  isCheckingUpdate.value = true
  updateState.value = 'idle'
  try {
    await window.electronAPI?.checkForUpdate()
  } catch (e) {
    console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', e)
    updateState.value = 'error'
    isCheckingUpdate.value = false
  }
}

const downloadUpdate = async () => {
  isDownloading.value = true
  downloadProgress.value = 0
  errorMessage.value = ''
  try {
    await window.electronAPI?.downloadUpdate()
  } catch (e) {
    console.error('ä¸‹è½½æ›´æ–°å¤±è´¥:', e)
    isDownloading.value = false
    updateState.value = 'download-error'
    errorMessage.value = 'ä¸‹è½½å¤±è´¥'
  }
}

const installUpdate = () => {
  window.electronAPI?.quitAndInstall()
}

const openGithub = () => {
  window.electronAPI?.openExternal('https://github.com/pigWolfy/desktop-beauty')
}

const openFeedback = () => {
  window.electronAPI?.openExternal('https://github.com/pigWolfy/desktop-beauty/issues')
}

const openAuthorGithub = () => {
  window.electronAPI?.openExternal('https://github.com/pigWolfy')
}
</script>

<style lang="scss" scoped>
.settings-view {
  animation: fadeIn 0.3s ease;
  max-width: 800px;
}

.settings-card {
  padding: 0;
  overflow: hidden;
}

.setting-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid $border-color;

  &:last-child {
    border-bottom: none;
  }

  .setting-info {
    display: flex;
    flex-direction: column;
    gap: 4px;

    .setting-label {
      font-weight: 500;
    }

    .setting-desc {
      font-size: 12px;
      color: $text-muted;
    }
  }
}

.switch {
  position: relative;
  width: 48px;
  height: 24px;
  flex-shrink: 0;

  input {
    opacity: 0;
    width: 0;
    height: 0;

    &:checked + .slider {
      background: $accent-primary;

      &::before {
        transform: translateX(24px);
      }
    }
  }

  .slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: $bg-secondary;
    border-radius: 24px;
    transition: all $transition-fast;

    &::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      left: 2px;
      bottom: 2px;
      background: white;
      border-radius: 50%;
      transition: all $transition-fast;
    }
  }
}

.select-box {
  padding: 8px 12px;
  background: $bg-secondary;
  color: $text-primary;
  border: 1px solid $border-color;
  border-radius: $border-radius-sm;
  cursor: pointer;
  min-width: 120px;

  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  &:focus {
    outline: none;
    border-color: $accent-primary;
  }
}

.shortcut-key {
  padding: 6px 12px;
  background: $bg-secondary;
  border: 1px solid $border-color;
  border-radius: 6px;
  font-family: monospace;
  font-size: 13px;
}

.about-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: 40px;

  .about-logo {
    font-size: 64px;
    margin-bottom: 16px;
  }

  h2 {
    font-size: 24px;
    font-weight: 600;
    background: $accent-gradient;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .version {
    font-size: 14px;
    color: $text-muted;
    margin-top: 8px;
  }

  .desc {
    font-size: 14px;
    color: $text-secondary;
    margin-top: 4px;
  }

  .developer-info {
    margin-top: 16px;
    font-size: 14px;
    color: $text-secondary;
    
    p {
      margin: 4px 0;
    }

    a {
      color: $accent-primary;
      text-decoration: none;

      &:hover {
        text-decoration: underline;
      }
    }
  }

  .about-links {
    display: flex;
    gap: 12px;
    margin-top: 24px;

    a {
      color: $accent-primary;
      text-decoration: none;

      &:hover {
        text-decoration: underline;
      }
    }

    span {
      color: $text-muted;
    }
  }

  .copyright {
    font-size: 12px;
    color: $text-muted;
    margin-top: 24px;
  }

  // æ›´æ–°ç›¸å…³æ ·å¼
  .update-section {
    margin: 20px 0;
    padding: 16px 24px;
    background: rgba($bg-secondary, 0.5);
    border-radius: $border-radius;
    min-width: 200px;
  }

  .update-check {
    display: flex;
    justify-content: center;
  }

  .btn-update {
    padding: 8px 24px;
    background: transparent;
    color: $text-primary;
    border: 1px solid $border-color;
    border-radius: $border-radius-sm;
    cursor: pointer;
    font-size: 14px;
    transition: all $transition-fast;

    &:hover:not(:disabled) {
      border-color: $accent-primary;
      color: $accent-primary;
    }

    &:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  }

  .update-available, .update-ready {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .update-badge {
    display: inline-block;
    padding: 4px 12px;
    background: $accent-gradient;
    color: white;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;

    &.success {
      background: linear-gradient(135deg, #10b981, #059669);
    }
  }

  .new-version {
    font-size: 18px;
    font-weight: 600;
    color: $accent-primary;
  }

  .btn-download, .btn-install {
    padding: 10px 28px;
    background: $accent-gradient;
    color: white;
    border: none;
    border-radius: $border-radius-sm;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all $transition-fast;

    &:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba($accent-primary, 0.3);
    }

    &:disabled {
      opacity: 0.8;
      cursor: not-allowed;
      transform: none;
    }
  }

  .btn-install {
    background: linear-gradient(135deg, #10b981, #059669);
  }

  .update-latest {
    .latest-badge {
      color: #10b981;
      font-size: 14px;
    }
  }

  .update-error {
    display: flex;
    align-items: center;
    gap: 12px;

    .error-text {
      color: #ef4444;
      font-size: 14px;
    }

    .btn-retry {
      padding: 6px 16px;
      background: transparent;
      color: $text-secondary;
      border: 1px solid $border-color;
      border-radius: $border-radius-sm;
      cursor: pointer;
      font-size: 13px;

      &:hover {
        border-color: $accent-primary;
        color: $accent-primary;
      }
    }
  }
}
</style>
