<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Desktop Beauty Analytics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); }
    .tab-active { border-bottom: 3px solid #667eea; color: #667eea; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  
  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
    <div class="glass rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 fade-in">
      <div class="text-center mb-8">
        <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-chart-line text-white text-3xl"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-800">Desktop Beauty</h1>
        <p class="text-gray-500 mt-2">Analytics Dashboard</p>
      </div>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
          <input type="text" id="username" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
          <input type="password" id="password" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="è¯·è¾“å…¥å¯†ç " required>
        </div>
        <div id="loginError" class="text-red-500 text-sm hidden"></div>
        <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition flex items-center justify-center">
          <span id="loginBtnText">ç™»å½•</span>
          <div id="loginLoader" class="loader ml-2 hidden" style="width: 20px; height: 20px;"></div>
        </button>
      </form>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="hidden">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
      <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fas fa-chart-line text-2xl"></i>
          <h1 class="text-xl font-bold">Desktop Beauty Analytics</h1>
        </div>
        <div class="flex items-center space-x-4">
          <select id="dateRange" class="bg-white/20 text-white px-4 py-2 rounded-lg outline-none cursor-pointer">
            <option value="7" class="text-gray-800">è¿‘7å¤©</option>
            <option value="14" class="text-gray-800">è¿‘14å¤©</option>
            <option value="30" class="text-gray-800" selected>è¿‘30å¤©</option>
            <option value="90" class="text-gray-800">è¿‘90å¤©</option>
          </select>
          <button id="refreshBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
            <i class="fas fa-sync-alt"></i>
          </button>
          <button id="logoutBtn" class="bg-red-500/80 hover:bg-red-500 px-4 py-2 rounded-lg transition">
            <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡º
          </button>
        </div>
      </div>
      <!-- Tabs -->
      <div class="container mx-auto px-4">
        <div class="flex space-x-6 overflow-x-auto">
          <button class="tab-btn tab-active px-4 py-3 font-medium whitespace-nowrap" data-tab="overview">
            <i class="fas fa-home mr-2"></i>æ¦‚è§ˆ
          </button>
          <button class="tab-btn px-4 py-3 font-medium whitespace-nowrap" data-tab="trends">
            <i class="fas fa-chart-area mr-2"></i>è¶‹åŠ¿
          </button>
          <button class="tab-btn px-4 py-3 font-medium whitespace-nowrap" data-tab="users">
            <i class="fas fa-users mr-2"></i>ç”¨æˆ·
          </button>
          <button class="tab-btn px-4 py-3 font-medium whitespace-nowrap" data-tab="geo">
            <i class="fas fa-globe-asia mr-2"></i>åœ°åŒº
          </button>
          <button class="tab-btn px-4 py-3 font-medium whitespace-nowrap" data-tab="features">
            <i class="fas fa-cubes mr-2"></i>åŠŸèƒ½
          </button>
          <button class="tab-btn px-4 py-3 font-medium whitespace-nowrap" data-tab="errors">
            <i class="fas fa-bug mr-2"></i>é”™è¯¯
          </button>
          <button class="tab-btn px-4 py-3 font-medium whitespace-nowrap" data-tab="systems">
            <i class="fas fa-desktop mr-2"></i>ç³»ç»Ÿ
          </button>
          <button class="tab-btn px-4 py-3 font-medium whitespace-nowrap" data-tab="live">
            <i class="fas fa-stream mr-2"></i>å®æ—¶
          </button>
        </div>
      </div>
    </header>

    <main class="container mx-auto px-4 py-6">
      <!-- Loading Indicator -->
      <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/20 flex items-center justify-center z-30">
        <div class="bg-white rounded-lg p-6 shadow-xl flex items-center space-x-4">
          <div class="loader"></div>
          <span class="text-gray-600">åŠ è½½ä¸­...</span>
        </div>
      </div>

      <!-- Overview Tab -->
      <div id="tab-overview" class="tab-content fade-in">
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
          <div class="glass rounded-xl shadow-lg p-5 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-xs font-medium">æ€»ç”¨æˆ·</p>
                <p id="totalUsers" class="text-2xl font-bold text-blue-600 mt-1">-</p>
              </div>
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-blue-600"></i>
              </div>
            </div>
          </div>
          <div class="glass rounded-xl shadow-lg p-5 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-xs font-medium">ä»Šæ—¥æ´»è·ƒ</p>
                <p id="activeUsersToday" class="text-2xl font-bold text-green-600 mt-1">-</p>
              </div>
              <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-user-check text-green-600"></i>
              </div>
            </div>
          </div>
          <div class="glass rounded-xl shadow-lg p-5 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-xs font-medium">æ€»äº‹ä»¶</p>
                <p id="totalEvents" class="text-2xl font-bold text-purple-600 mt-1">-</p>
              </div>
              <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-bolt text-purple-600"></i>
              </div>
            </div>
          </div>
          <div class="glass rounded-xl shadow-lg p-5 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-xs font-medium">ä¼šè¯æ•°</p>
                <p id="totalSessions" class="text-2xl font-bold text-orange-600 mt-1">-</p>
              </div>
              <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-clock text-orange-600"></i>
              </div>
            </div>
          </div>
          <div class="glass rounded-xl shadow-lg p-5 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-xs font-medium">å¹³å‡æ—¶é•¿</p>
                <p id="avgSessionDuration" class="text-2xl font-bold text-cyan-600 mt-1">-</p>
              </div>
              <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-hourglass-half text-cyan-600"></i>
              </div>
            </div>
          </div>
          <div class="glass rounded-xl shadow-lg p-5 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-xs font-medium">é”™è¯¯æ•°</p>
                <p id="errorCount" class="text-2xl font-bold text-red-600 mt-1">-</p>
              </div>
              <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="glass rounded-xl shadow-lg p-6 card-hover">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-code-branch mr-2 text-purple-500"></i>ç‰ˆæœ¬åˆ†å¸ƒ</h3>
            <canvas id="versionChart" height="200"></canvas>
          </div>
          <div class="glass rounded-xl shadow-lg p-6 card-hover">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-laptop mr-2 text-blue-500"></i>å¹³å°åˆ†å¸ƒ</h3>
            <canvas id="platformChart" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Trends Tab -->
      <div id="tab-trends" class="tab-content hidden fade-in">
        <div class="glass rounded-xl shadow-lg p-6 mb-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-chart-line mr-2 text-green-500"></i>ç”¨æˆ·æ´»è·ƒè¶‹åŠ¿</h3>
          <canvas id="trendsChart" height="300"></canvas>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-undo mr-2 text-orange-500"></i>ç”¨æˆ·ç•™å­˜</h3>
            <div id="retentionTable" class="overflow-x-auto"></div>
          </div>
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-file-alt mr-2 text-indigo-500"></i>é¡µé¢è®¿é—®</h3>
            <canvas id="pageViewChart" height="250"></canvas>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="tab-users" class="tab-content hidden fade-in">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="glass rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500">æ€»ç”¨æˆ·æ•°</p>
                <p id="usersTotalUsers" class="text-3xl font-bold text-gray-800">-</p>
              </div>
              <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                <i class="fas fa-users text-blue-500 text-xl"></i>
              </div>
            </div>
          </div>
          <div class="glass rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500">æ–°ç”¨æˆ· (7å¤©)</p>
                <p id="usersNewUsers" class="text-3xl font-bold text-green-600">-</p>
              </div>
              <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                <i class="fas fa-user-plus text-green-500 text-xl"></i>
              </div>
            </div>
          </div>
          <div class="glass rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500">äººå‡ä¼šè¯</p>
                <p id="usersAvgSessions" class="text-3xl font-bold text-purple-600">-</p>
              </div>
              <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                <i class="fas fa-clock text-purple-500 text-xl"></i>
              </div>
            </div>
          </div>
          <div class="glass rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500">äººå‡äº‹ä»¶</p>
                <p id="usersAvgEvents" class="text-3xl font-bold text-orange-600">-</p>
              </div>
              <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center">
                <i class="fas fa-bolt text-orange-500 text-xl"></i>
              </div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- Activity Distribution -->
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-chart-pie mr-2 text-pink-500"></i>ç”¨æˆ·æ´»è·ƒåº¦åˆ†å¸ƒ</h3>
            <canvas id="userActivityChart" height="280"></canvas>
          </div>
          <!-- DAU Trend -->
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-chart-line mr-2 text-blue-500"></i>æ—¥æ´»è·ƒç”¨æˆ· (DAU)</h3>
            <canvas id="dauTrendChart" height="280"></canvas>
          </div>
        </div>

        <!-- Top Users Table -->
        <div class="glass rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-trophy mr-2 text-yellow-500"></i>æ´»è·ƒç”¨æˆ·æ’è¡Œ (Top 20)</h3>
          <div id="topUsersTable" class="overflow-x-auto"></div>
        </div>
      </div>

      <!-- Geo Tab -->
      <div id="tab-geo" class="tab-content hidden fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- Country Chart -->
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-flag mr-2 text-blue-500"></i>å›½å®¶/åœ°åŒºåˆ†å¸ƒ</h3>
            <canvas id="countryChart" height="280"></canvas>
          </div>
          <!-- City Chart -->
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-city mr-2 text-green-500"></i>åŸå¸‚åˆ†å¸ƒ (Top 15)</h3>
            <canvas id="cityChart" height="280"></canvas>
          </div>
        </div>
        
        <!-- City Table -->
        <div class="glass rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-map-marker-alt mr-2 text-red-500"></i>ç”¨æˆ·åŸå¸‚æ’è¡Œ (æŒ‰ç‹¬ç«‹ç”¨æˆ·æ•°)</h3>
          <div id="cityTable" class="overflow-x-auto"></div>
        </div>
      </div>

      <!-- Features Tab -->
      <div id="tab-features" class="tab-content hidden fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-puzzle-piece mr-2 text-pink-500"></i>åŠŸèƒ½åˆ†ç±»</h3>
            <canvas id="featureCategoryChart" height="300"></canvas>
          </div>
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-fire mr-2 text-red-500"></i>çƒ­é—¨æ“ä½œ (Top 20)</h3>
            <div id="topActionsTable" class="overflow-y-auto max-h-96"></div>
          </div>
        </div>
      </div>

      <!-- Errors Tab -->
      <div id="tab-errors" class="tab-content hidden fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-tags mr-2 text-yellow-500"></i>é”™è¯¯ç±»å‹</h3>
            <canvas id="errorTypeChart" height="250"></canvas>
          </div>
          <div class="glass rounded-xl shadow-lg p-6 lg:col-span-2">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-list mr-2 text-red-500"></i>é«˜é¢‘é”™è¯¯</h3>
            <div id="topErrorsTable" class="overflow-y-auto max-h-72"></div>
          </div>
        </div>
        <div class="glass rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-history mr-2 text-gray-500"></i>æœ€è¿‘é”™è¯¯</h3>
          <div id="recentErrorsTable" class="overflow-x-auto"></div>
        </div>
      </div>

      <!-- Systems Tab -->
      <div id="tab-systems" class="tab-content hidden fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-microchip mr-2 text-blue-500"></i>CPU åˆ†å¸ƒ</h3>
            <div id="cpuTable" class="overflow-y-auto max-h-80"></div>
          </div>
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-gamepad mr-2 text-green-500"></i>GPU åˆ†å¸ƒ</h3>
            <div id="gpuTable" class="overflow-y-auto max-h-80"></div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-memory mr-2 text-purple-500"></i>å†…å­˜åˆ†å¸ƒ</h3>
            <canvas id="memoryChart" height="250"></canvas>
          </div>
          <div class="glass rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4"><i class="fas fa-tv mr-2 text-orange-500"></i>åˆ†è¾¨ç‡åˆ†å¸ƒ</h3>
            <canvas id="resolutionChart" height="250"></canvas>
          </div>
        </div>
      </div>

      <!-- Live Tab -->
      <div id="tab-live" class="tab-content hidden fade-in">
        <div class="glass rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-700"><i class="fas fa-broadcast-tower mr-2 text-red-500 animate-pulse"></i>å®æ—¶äº‹ä»¶æµ</h3>
            <div class="flex items-center space-x-2">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-1 animate-pulse"></span>
                Live
              </span>
              <button id="pauseLive" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-pause"></i>
              </button>
            </div>
          </div>
          <div id="liveEventsTable" class="overflow-x-auto max-h-[600px]"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ==================== é…ç½® ====================
    const API_BASE = '/api';
    let authToken = localStorage.getItem('authToken');
    let charts = {};
    let liveInterval = null;
    let isPaused = false;

    // ==================== è®¤è¯ ====================
    async function login(username, password) {
      const res = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      
      if (!res.ok) throw new Error('ç™»å½•å¤±è´¥');
      
      const data = await res.json();
      authToken = data.token;
      localStorage.setItem('authToken', authToken);
      return data;
    }

    async function logout() {
      try {
        await fetch(`${API_BASE}/auth/logout`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
      } catch (e) {}
      localStorage.removeItem('authToken');
      authToken = null;
      showLogin();
    }

    async function verifyToken() {
      if (!authToken) return false;
      try {
        const res = await fetch(`${API_BASE}/auth/verify`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        return res.ok;
      } catch (e) {
        return false;
      }
    }

    function showLogin() {
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('dashboard').classList.add('hidden');
    }

    function showDashboard() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      loadOverview();
    }

    // ==================== API è¯·æ±‚ ====================
    async function apiGet(endpoint) {
      const res = await fetch(`${API_BASE}${endpoint}`, {
        headers: { 'Authorization': `Bearer ${authToken}` }
      });
      if (res.status === 401) {
        showLogin();
        throw new Error('Unauthorized');
      }
      return res.json();
    }

    function getDateRange() {
      const days = parseInt(document.getElementById('dateRange').value);
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      return { startDate, endDate, days };
    }

    // ==================== æ•°æ®åŠ è½½ ====================
    function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

    async function loadOverview() {
      showLoading();
      try {
        const { startDate, endDate } = getDateRange();
        const data = await apiGet(`/dashboard/overview?startDate=${startDate}&endDate=${endDate}`);
        
        document.getElementById('totalUsers').textContent = data.totalUsers.toLocaleString();
        document.getElementById('activeUsersToday').textContent = data.activeUsersToday.toLocaleString();
        document.getElementById('totalEvents').textContent = data.totalEvents.toLocaleString();
        document.getElementById('totalSessions').textContent = data.totalSessions.toLocaleString();
        document.getElementById('avgSessionDuration').textContent = formatDuration(data.avgSessionDuration);
        document.getElementById('errorCount').textContent = data.errorCount.toLocaleString();

        // Version Chart
        destroyChart('versionChart');
        const versionLabels = data.versions.slice(0, 8).map(v => v.version);
        const versionData = data.versions.slice(0, 8).map(v => v.count);
        charts.versionChart = new Chart(document.getElementById('versionChart'), {
          type: 'doughnut',
          data: {
            labels: versionLabels,
            datasets: [{ data: versionData, backgroundColor: generateColors(versionLabels.length) }]
          },
          options: { responsive: true, plugins: { legend: { position: 'right' } } }
        });

        // Platform Chart
        destroyChart('platformChart');
        const platformLabels = data.platforms.map(p => p.platform);
        const platformData = data.platforms.map(p => p.count);
        charts.platformChart = new Chart(document.getElementById('platformChart'), {
          type: 'pie',
          data: {
            labels: platformLabels,
            datasets: [{ data: platformData, backgroundColor: ['#3B82F6', '#10B981', '#F59E0B'] }]
          },
          options: { responsive: true, plugins: { legend: { position: 'right' } } }
        });
      } catch (e) { console.error(e); }
      hideLoading();
    }

    async function loadTrends() {
      showLoading();
      try {
        const { days } = getDateRange();
        const [trendsData, pagesData, retentionData] = await Promise.all([
          apiGet(`/dashboard/trends?days=${days}`),
          apiGet(`/dashboard/pages?${new URLSearchParams(getDateRange())}`),
          apiGet(`/dashboard/retention?weeks=${Math.ceil(days / 7)}`)
        ]);

        // Trends Chart
        destroyChart('trendsChart');
        const labels = trendsData.trends.map(t => t.date);
        charts.trendsChart = new Chart(document.getElementById('trendsChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'æ´»è·ƒç”¨æˆ·', data: trendsData.trends.map(t => t.users), borderColor: '#3B82F6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3 },
              { label: 'ä¼šè¯æ•°', data: trendsData.trends.map(t => t.sessions), borderColor: '#10B981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3 },
              { label: 'é”™è¯¯æ•°', data: trendsData.trends.map(t => t.errors), borderColor: '#EF4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.3, hidden: true }
            ]
          },
          options: { responsive: true, interaction: { mode: 'index', intersect: false }, scales: { y: { beginAtZero: true } } }
        });

        // Page View Chart
        destroyChart('pageViewChart');
        charts.pageViewChart = new Chart(document.getElementById('pageViewChart'), {
          type: 'bar',
          data: {
            labels: pagesData.pageViews.map(p => p.name),
            datasets: [{ label: 'è®¿é—®é‡', data: pagesData.pageViews.map(p => p.count), backgroundColor: generateColors(pagesData.pageViews.length) }]
          },
          options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false } } }
        });

        // Retention Table
        let retentionHtml = '<table class="min-w-full text-sm"><thead><tr><th class="px-2 py-1 text-left">å‘¨</th>';
        for (let i = 0; i < 4; i++) retentionHtml += `<th class="px-2 py-1 text-center">Week ${i}</th>`;
        retentionHtml += '</tr></thead><tbody>';
        retentionData.retention.forEach(r => {
          retentionHtml += `<tr><td class="px-2 py-1">${r.week}</td>`;
          r.retention.slice(0, 4).forEach((ret, i) => {
            const color = ret.rate > 50 ? 'bg-green-100' : ret.rate > 20 ? 'bg-yellow-100' : 'bg-red-100';
            retentionHtml += `<td class="px-2 py-1 text-center ${color}">${ret.rate}%</td>`;
          });
          retentionHtml += '</tr>';
        });
        retentionHtml += '</tbody></table>';
        document.getElementById('retentionTable').innerHTML = retentionHtml;

      } catch (e) { console.error(e); }
      hideLoading();
    }

    async function loadGeo() {
      showLoading();
      try {
        const data = await apiGet(`/dashboard/geo?${new URLSearchParams(getDateRange())}`);
        
        // Country Chart (æŒ‰ç”¨æˆ·æ•°)
        destroyChart('countryChart');
        if (data.countriesByUsers && data.countriesByUsers.length > 0) {
          charts.countryChart = new Chart(document.getElementById('countryChart'), {
            type: 'doughnut',
            data: {
              labels: data.countriesByUsers.map(c => c.name),
              datasets: [{
                data: data.countriesByUsers.map(c => c.count),
                backgroundColor: generateColors(data.countriesByUsers.length)
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'right' },
                tooltip: {
                  callbacks: {
                    label: function(ctx) {
                      const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                      const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                      return `${ctx.label}: ${ctx.raw} ç”¨æˆ· (${pct}%)`;
                    }
                  }
                }
              }
            }
          });
        }
        
        // City Chart (æŒ‰ç”¨æˆ·æ•° Top 15)
        destroyChart('cityChart');
        if (data.citiesByUsers && data.citiesByUsers.length > 0) {
          const topCities = data.citiesByUsers.slice(0, 15);
          charts.cityChart = new Chart(document.getElementById('cityChart'), {
            type: 'bar',
            data: {
              labels: topCities.map(c => c.name.split(',')[0]),  // åªæ˜¾ç¤ºåŸå¸‚å
              datasets: [{
                label: 'ç”¨æˆ·æ•°',
                data: topCities.map(c => c.count),
                backgroundColor: '#10B981'
              }]
            },
            options: {
              responsive: true,
              indexAxis: 'y',
              plugins: { legend: { display: false } },
              scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
          });
        }
        
        // City Table
        let cityHtml = `<table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left">#</th>
              <th class="px-3 py-2 text-left">åŸå¸‚</th>
              <th class="px-3 py-2 text-left">å›½å®¶</th>
              <th class="px-3 py-2 text-right">ç”¨æˆ·æ•°</th>
            </tr>
          </thead>
          <tbody>`;
        
        data.citiesByUsers.forEach((city, i) => {
          const [cityName, country] = city.name.split(', ');
          const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i + 1);
          cityHtml += `<tr class="${i % 2 === 0 ? 'bg-gray-50' : ''} hover:bg-blue-50">
            <td class="px-3 py-2 font-semibold">${medal}</td>
            <td class="px-3 py-2"><i class="fas fa-map-marker-alt text-red-400 mr-2"></i>${cityName}</td>
            <td class="px-3 py-2 text-gray-600">${country || '-'}</td>
            <td class="px-3 py-2 text-right font-mono font-semibold text-green-600">${city.count}</td>
          </tr>`;
        });
        
        cityHtml += '</tbody></table>';
        document.getElementById('cityTable').innerHTML = cityHtml || '<p class="text-gray-500 text-center py-8">æš‚æ— åœ°ç†ä½ç½®æ•°æ®</p>';

      } catch (e) { console.error(e); }
      hideLoading();
    }

    async function loadFeatures() {
      showLoading();
      try {
        const data = await apiGet(`/dashboard/features?${new URLSearchParams(getDateRange())}`);
        
        // Category Chart
        destroyChart('featureCategoryChart');
        charts.featureCategoryChart = new Chart(document.getElementById('featureCategoryChart'), {
          type: 'polarArea',
          data: {
            labels: data.categories.map(c => c.name),
            datasets: [{ data: data.categories.map(c => c.count), backgroundColor: generateColors(data.categories.length, 0.7) }]
          },
          options: { responsive: true }
        });

        // Top Actions Table
        let actionsHtml = '<table class="min-w-full text-sm"><thead><tr><th class="px-3 py-2 text-left">æ“ä½œ</th><th class="px-3 py-2 text-right">æ¬¡æ•°</th></tr></thead><tbody>';
        data.actions.forEach((a, i) => {
          actionsHtml += `<tr class="${i % 2 === 0 ? 'bg-gray-50' : ''}"><td class="px-3 py-2">${a.name}</td><td class="px-3 py-2 text-right font-mono">${a.count.toLocaleString()}</td></tr>`;
        });
        actionsHtml += '</tbody></table>';
        document.getElementById('topActionsTable').innerHTML = actionsHtml;

      } catch (e) { console.error(e); }
      hideLoading();
    }

    async function loadErrors() {
      showLoading();
      try {
        const data = await apiGet(`/dashboard/errors?${new URLSearchParams(getDateRange())}`);
        
        // Error Type Chart
        destroyChart('errorTypeChart');
        charts.errorTypeChart = new Chart(document.getElementById('errorTypeChart'), {
          type: 'doughnut',
          data: {
            labels: data.byType.map(e => e.type),
            datasets: [{ data: data.byType.map(e => e.count), backgroundColor: ['#EF4444', '#F59E0B', '#8B5CF6', '#EC4899', '#6366F1'] }]
          },
          options: { responsive: true }
        });

        // Top Errors Table
        let topHtml = '<table class="min-w-full text-sm"><tbody>';
        data.topMessages.forEach((e, i) => {
          topHtml += `<tr class="${i % 2 === 0 ? 'bg-red-50' : ''}"><td class="px-3 py-2 truncate max-w-md" title="${e.message}">${e.message}</td><td class="px-3 py-2 text-right font-mono text-red-600">${e.count}</td></tr>`;
        });
        topHtml += '</tbody></table>';
        document.getElementById('topErrorsTable').innerHTML = topHtml;

        // Recent Errors Table
        let recentHtml = '<table class="min-w-full text-sm"><thead><tr><th class="px-3 py-2 text-left">æ—¶é—´</th><th class="px-3 py-2 text-left">ç±»å‹</th><th class="px-3 py-2 text-left">æ¶ˆæ¯</th><th class="px-3 py-2 text-left">ç‰ˆæœ¬</th></tr></thead><tbody>';
        data.recent.slice(0, 20).forEach((e, i) => {
          recentHtml += `<tr class="${i % 2 === 0 ? 'bg-gray-50' : ''}">
            <td class="px-3 py-2 text-gray-500 whitespace-nowrap">${new Date(e.timestamp).toLocaleString()}</td>
            <td class="px-3 py-2"><span class="px-2 py-1 rounded text-xs ${e.severity === 'critical' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${e.type || '-'}</span></td>
            <td class="px-3 py-2 truncate max-w-xs" title="${e.message || ''}">${e.message || '-'}</td>
            <td class="px-3 py-2 text-gray-500">${e.appVersion || '-'}</td>
          </tr>`;
        });
        recentHtml += '</tbody></table>';
        document.getElementById('recentErrorsTable').innerHTML = recentHtml;

      } catch (e) { console.error(e); }
      hideLoading();
    }

    async function loadSystems() {
      showLoading();
      try {
        const data = await apiGet(`/dashboard/systems?${new URLSearchParams(getDateRange())}`);
        
        // CPU Table
        let cpuHtml = '<table class="min-w-full text-sm"><tbody>';
        data.cpuModels.forEach((c, i) => {
          cpuHtml += `<tr class="${i % 2 === 0 ? 'bg-gray-50' : ''}"><td class="px-3 py-2 truncate max-w-xs" title="${c.model}">${c.model}</td><td class="px-3 py-2 text-right font-mono">${c.count}</td></tr>`;
        });
        cpuHtml += '</tbody></table>';
        document.getElementById('cpuTable').innerHTML = cpuHtml;

        // GPU Table
        let gpuHtml = '<table class="min-w-full text-sm"><tbody>';
        data.gpuModels.forEach((g, i) => {
          gpuHtml += `<tr class="${i % 2 === 0 ? 'bg-gray-50' : ''}"><td class="px-3 py-2 truncate max-w-xs" title="${g.model}">${g.model}</td><td class="px-3 py-2 text-right font-mono">${g.count}</td></tr>`;
        });
        gpuHtml += '</tbody></table>';
        document.getElementById('gpuTable').innerHTML = gpuHtml;

        // Memory Chart
        destroyChart('memoryChart');
        charts.memoryChart = new Chart(document.getElementById('memoryChart'), {
          type: 'bar',
          data: {
            labels: data.memoryDistribution.map(m => m.range),
            datasets: [{ label: 'ç”¨æˆ·æ•°', data: data.memoryDistribution.map(m => m.count), backgroundColor: '#8B5CF6' }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });

        // Resolution Chart
        destroyChart('resolutionChart');
        charts.resolutionChart = new Chart(document.getElementById('resolutionChart'), {
          type: 'bar',
          data: {
            labels: data.resolutions.map(r => r.resolution),
            datasets: [{ label: 'ç”¨æˆ·æ•°', data: data.resolutions.map(r => r.count), backgroundColor: '#F59E0B' }]
          },
          options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { maxRotation: 45 } } } }
        });

      } catch (e) { console.error(e); }
      hideLoading();
    }

    async function loadUsers() {
      showLoading();
      try {
        const data = await apiGet(`/dashboard/users?${new URLSearchParams(getDateRange())}`);
        
        // Update summary cards
        document.getElementById('usersTotalUsers').textContent = data.totalUsers.toLocaleString();
        document.getElementById('usersNewUsers').textContent = data.newUsers.toLocaleString();
        document.getElementById('usersAvgSessions').textContent = data.avgSessionsPerUser;
        document.getElementById('usersAvgEvents').textContent = data.avgEventsPerUser.toLocaleString();

        // Activity Distribution Chart
        destroyChart('userActivityChart');
        charts.userActivityChart = new Chart(document.getElementById('userActivityChart'), {
          type: 'doughnut',
          data: {
            labels: data.activityDistribution.map(d => d.type),
            datasets: [{
              data: data.activityDistribution.map(d => d.count),
              backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'right' },
              tooltip: {
                callbacks: {
                  label: function(ctx) {
                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                    const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                    return `${ctx.label}: ${ctx.raw} (${pct}%)`;
                  }
                }
              }
            }
          }
        });

        // DAU Trend Chart
        destroyChart('dauTrendChart');
        if (data.dauTrend && data.dauTrend.length > 0) {
          charts.dauTrendChart = new Chart(document.getElementById('dauTrendChart'), {
            type: 'line',
            data: {
              labels: data.dauTrend.map(d => d.date),
              datasets: [{
                label: 'æ—¥æ´»è·ƒç”¨æˆ·',
                data: data.dauTrend.map(d => d.count),
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
          });
        }

        // Top Users Table
        let usersHtml = `<table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 text-left">#</th>
              <th class="px-3 py-2 text-left">ç”¨æˆ·ID</th>
              <th class="px-3 py-2 text-right">ä¼šè¯æ•°</th>
              <th class="px-3 py-2 text-right">äº‹ä»¶æ•°</th>
              <th class="px-3 py-2 text-right">åŠŸèƒ½æ•°</th>
              <th class="px-3 py-2 text-left">é¦–æ¬¡ä½¿ç”¨</th>
              <th class="px-3 py-2 text-left">æœ€åæ´»è·ƒ</th>
              <th class="px-3 py-2 text-left">å¹³å°</th>
            </tr>
          </thead>
          <tbody>`;
        
        data.topUsers.forEach((user, i) => {
          const firstSeen = new Date(user.firstSeen).toLocaleDateString();
          const lastSeen = new Date(user.lastSeen).toLocaleDateString();
          const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i + 1);
          
          usersHtml += `<tr class="${i % 2 === 0 ? 'bg-gray-50' : ''} hover:bg-blue-50">
            <td class="px-3 py-2 font-semibold">${medal}</td>
            <td class="px-3 py-2 font-mono text-gray-600" title="${user.fullId}">${user.userId}</td>
            <td class="px-3 py-2 text-right font-mono text-blue-600 font-semibold">${user.sessionCount}</td>
            <td class="px-3 py-2 text-right font-mono">${user.eventCount.toLocaleString()}</td>
            <td class="px-3 py-2 text-right">${user.featureCount}</td>
            <td class="px-3 py-2 text-gray-500">${firstSeen}</td>
            <td class="px-3 py-2 text-gray-500">${lastSeen}</td>
            <td class="px-3 py-2">${user.platforms.join(', ')}</td>
          </tr>`;
        });
        
        usersHtml += '</tbody></table>';
        document.getElementById('topUsersTable').innerHTML = usersHtml;

      } catch (e) { console.error(e); }
      hideLoading();
    }

    async function loadLive() {
      if (isPaused) return;
      try {
        const data = await apiGet('/dashboard/live?limit=100');
        
        let html = '<table class="min-w-full text-sm"><thead class="sticky top-0 bg-white"><tr><th class="px-3 py-2 text-left">æ—¶é—´</th><th class="px-3 py-2 text-left">äº‹ä»¶</th><th class="px-3 py-2 text-left">ç”¨æˆ·</th><th class="px-3 py-2 text-left">åŸå¸‚</th><th class="px-3 py-2 text-left">ç‰ˆæœ¬</th><th class="px-3 py-2 text-left">è¯¦æƒ…</th></tr></thead><tbody>';
        data.logs.forEach((l, i) => {
          const typeColor = {
            'app_start': 'bg-green-100 text-green-700',
            'app_quit': 'bg-gray-100 text-gray-700',
            'page_view': 'bg-blue-100 text-blue-700',
            'feature_use': 'bg-purple-100 text-purple-700',
            'error': 'bg-red-100 text-red-700'
          }[l.eventType] || 'bg-gray-100 text-gray-700';
          
          const cityDisplay = l.city && l.city !== '-' && l.city !== 'Unknown' ? l.city : '-';
          
          html += `<tr class="${i % 2 === 0 ? 'bg-gray-50' : ''}">
            <td class="px-3 py-2 text-gray-500 whitespace-nowrap">${new Date(l.timestamp).toLocaleTimeString()}</td>
            <td class="px-3 py-2"><span class="px-2 py-1 rounded text-xs ${typeColor}">${l.eventType}</span></td>
            <td class="px-3 py-2 font-mono text-gray-600">${l.userId || '-'}</td>
            <td class="px-3 py-2 text-gray-600">${cityDisplay !== '-' ? '<i class="fas fa-map-marker-alt text-red-400 mr-1"></i>' + cityDisplay : '-'}</td>
            <td class="px-3 py-2 text-gray-500">${l.appVersion || '-'}</td>
            <td class="px-3 py-2 text-gray-600 truncate max-w-xs">${l.details}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('liveEventsTable').innerHTML = html;
      } catch (e) { console.error(e); }
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    function destroyChart(id) {
      if (charts[id]) {
        charts[id].destroy();
        charts[id] = null;
      }
    }

    function generateColors(count, alpha = 1) {
      const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#84CC16'];
      return Array(count).fill(0).map((_, i) => {
        const color = colors[i % colors.length];
        if (alpha < 1) {
          const r = parseInt(color.slice(1,3), 16);
          const g = parseInt(color.slice(3,5), 16);
          const b = parseInt(color.slice(5,7), 16);
          return `rgba(${r},${g},${b},${alpha})`;
        }
        return color;
      });
    }

    function formatDuration(seconds) {
      if (!seconds) return '0s';
      if (seconds < 60) return `${seconds}s`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
      return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
    }

    // ==================== äº‹ä»¶å¤„ç† ====================
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorEl = document.getElementById('loginError');
      const btnText = document.getElementById('loginBtnText');
      const loader = document.getElementById('loginLoader');

      btnText.textContent = 'ç™»å½•ä¸­...';
      loader.classList.remove('hidden');
      errorEl.classList.add('hidden');

      try {
        await login(username, password);
        showDashboard();
      } catch (e) {
        errorEl.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        errorEl.classList.remove('hidden');
      } finally {
        btnText.textContent = 'ç™»å½•';
        loader.classList.add('hidden');
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', logout);
    
    document.getElementById('refreshBtn').addEventListener('click', () => {
      const activeTab = document.querySelector('.tab-btn.tab-active').dataset.tab;
      loadTab(activeTab);
    });

    document.getElementById('dateRange').addEventListener('change', () => {
      const activeTab = document.querySelector('.tab-btn.tab-active').dataset.tab;
      loadTab(activeTab);
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        btn.classList.add('tab-active');
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
        
        loadTab(btn.dataset.tab);
      });
    });

    document.getElementById('pauseLive').addEventListener('click', () => {
      isPaused = !isPaused;
      document.getElementById('pauseLive').innerHTML = isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
    });

    function loadTab(tab) {
      if (liveInterval) { clearInterval(liveInterval); liveInterval = null; }
      
      switch (tab) {
        case 'overview': loadOverview(); break;
        case 'trends': loadTrends(); break;
        case 'users': loadUsers(); break;
        case 'geo': loadGeo(); break;
        case 'features': loadFeatures(); break;
        case 'errors': loadErrors(); break;
        case 'systems': loadSystems(); break;
        case 'live':
          loadLive();
          liveInterval = setInterval(loadLive, 5000);
          break;
      }
    }

    // ==================== åˆå§‹åŒ– ====================
    (async () => {
      if (await verifyToken()) {
        showDashboard();
      } else {
        showLogin();
      }
    })();
  </script>
</body>
</html>
